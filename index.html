<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yahtzee Multiplayer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <style>
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }
    @keyframes celebrateBounce {
      0%, 100% { transform: scale(1) translateY(0); }
      50% { transform: scale(1.1) translateY(-10px); }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    const firebaseConfig = {
      apiKey: "AIzaSyCUyJejB7mdI8rGLf_gYXHSZg7yBP9tnvU",
      authDomain: "yahtzee-f4a0c.firebaseapp.com",
      databaseURL: "https://yahtzee-f4a0c-default-rtdb.firebaseio.com",
      projectId: "yahtzee-f4a0c",
      storageBucket: "yahtzee-f4a0c.firebasestorage.app",
      messagingSenderId: "364630156499",
      appId: "1:364630156499:web:d55ca54578f23395106026"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const database = firebase.database();

    const CATEGORIES = [
      { id: 'ones', name: 'Ones', upper: true },
      { id: 'twos', name: 'Twos', upper: true },
      { id: 'threes', name: 'Threes', upper: true },
      { id: 'fours', name: 'Fours', upper: true },
      { id: 'fives', name: 'Fives', upper: true },
      { id: 'sixes', name: 'Sixes', upper: true },
      { id: 'threeOfKind', name: 'Three of a Kind', upper: false },
      { id: 'fourOfKind', name: 'Four of a Kind', upper: false },
      { id: 'fullHouse', name: 'Full House', upper: false },
      { id: 'smallStraight', name: 'Small Straight', upper: false },
      { id: 'largeStraight', name: 'Large Straight', upper: false },
      { id: 'yahtzee', name: 'Yahtzee', upper: false },
      { id: 'chance', name: 'Chance', upper: false }
    ];

    const THEMES = {
      purple: 'from-indigo-600 via-purple-600 to-pink-600',
      ocean: 'from-blue-600 via-cyan-600 to-teal-600',
      sunset: 'from-orange-600 via-red-600 to-pink-600',
      forest: 'from-green-600 via-emerald-600 to-teal-600',
    };

    function Die3D({ value, locked, onClick, isRolling }) {
      const [rotation, setRotation] = useState({ x: 0, y: 0, z: 0 });
      const [isAnimating, setIsAnimating] = useState(false);
      
      const valueToRotation = {
        1: { x: 0, y: 0, z: 0 },
        2: { x: 0, y: -90, z: 0 },
        3: { x: 90, y: 0, z: 0 },
        4: { x: -90, y: 0, z: 0 },
        5: { x: 0, y: 90, z: 0 },
        6: { x: 0, y: 180, z: 0 }
      };

      useEffect(() => {
        if (!isRolling) {
          setRotation(valueToRotation[value]);
          setIsAnimating(false);
        }
      }, [value, isRolling]);
      
      useEffect(() => {
        if (isRolling && !locked) {
          setIsAnimating(true);
          const interval = setInterval(() => {
            setRotation({
              x: Math.random() * 720 - 360,
              y: Math.random() * 720 - 360,
              z: Math.random() * 720 - 360
            });
          }, 16);
          return () => clearInterval(interval);
        } else {
          setIsAnimating(false);
        }
      }, [isRolling, locked]);

      const renderDots = (faceValue) => {
        const dotPositions = {
          1: [[0, 0]],
          2: [[-20, -20], [20, 20]],
          3: [[-20, -20], [0, 0], [20, 20]],
          4: [[-20, -20], [20, -20], [-20, 20], [20, 20]],
          5: [[-20, -20], [20, -20], [0, 0], [-20, 20], [20, 20]],
          6: [[-20, -20], [20, -20], [-20, 0], [20, 0], [-20, 20], [20, 20]]
        };

        return (
          <div style={{ position: 'absolute', inset: 0, display: 'flex', alignItems: 'center', justifyContent: 'center' }}>
            {dotPositions[faceValue].map(([x, y], i) => (
              <div
                key={i}
                style={{
                  position: 'absolute',
                  width: '12px',
                  height: '12px',
                  borderRadius: '50%',
                  backgroundColor: locked ? '#fbbf24' : '#1f2937',
                  transform: `translate(${x}px, ${y}px)`
                }}
              />
            ))}
          </div>
        );
      };

      return (
        <div style={{ position: 'relative', width: '100px', height: '100px', perspective: '600px', margin: '10px' }}>
          <div
            onClick={onClick}
            style={{
              width: '80px',
              height: '80px',
              position: 'absolute',
              left: '10px',
              top: '10px',
              transformStyle: 'preserve-3d',
              transform: `rotateX(${rotation.x}deg) rotateY(${rotation.y}deg) rotateZ(${rotation.z}deg)`,
              transition: (isRolling || isAnimating) ? 'none' : 'transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1)',
              cursor: 'pointer'
            }}
          >
            {[
              { face: 1, transform: 'rotateY(0deg) translateZ(40px)' },
              { face: 2, transform: 'rotateY(90deg) translateZ(40px)' },
              { face: 3, transform: 'rotateX(-90deg) translateZ(40px)' },
              { face: 4, transform: 'rotateX(90deg) translateZ(40px)' },
              { face: 5, transform: 'rotateY(-90deg) translateZ(40px)' },
              { face: 6, transform: 'rotateY(180deg) translateZ(40px)' }
            ].map(({ face, transform }) => (
              <div
                key={face}
                style={{
                  position: 'absolute',
                  width: '100%',
                  height: '100%',
                  borderRadius: '8px',
                  border: '2px solid',
                  borderColor: locked ? '#047857' : '#d1d5db',
                  background: locked ? 'linear-gradient(to bottom right, #34d399, #059669)' : 'linear-gradient(to bottom right, #ffffff, #f3f4f6)',
                  transform: transform,
                  backfaceVisibility: 'hidden',
                  boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)'
                }}
              >
                {renderDots(face)}
              </div>
            ))}
          </div>
          {locked && (
            <div style={{
              position: 'absolute',
              top: '-4px',
              right: '-4px',
              backgroundColor: '#fbbf24',
              color: '#78350f',
              borderRadius: '50%',
              width: '28px',
              height: '28px',
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              fontSize: '12px',
              fontWeight: 'bold',
              boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)',
              border: '2px solid #d97706',
              zIndex: 10
            }}>
              üîí
            </div>
          )}
        </div>
      );
    }

    function YahtzeeGame() {
      const [gameMode, setGameMode] = useState('menu');
      const [roomCode, setRoomCode] = useState('');
      const [roomCodeInput, setRoomCodeInput] = useState('');
      const [username, setUsername] = useState('');
      const [myPlayerId, setMyPlayerId] = useState('');
      const [roomData, setRoomData] = useState(null);
      const [copied, setCopied] = useState(false);
      const [darkMode, setDarkMode] = useState(true);
      const [currentTheme] = useState('purple');
      const [soundEnabled, setSoundEnabled] = useState(true);
      const [showYahtzeeCelebration, setShowYahtzeeCelebration] = useState(false);
      const [showDebug, setShowDebug] = useState(false);
      const [selectedPlayerStats, setSelectedPlayerStats] = useState(null);
      const [playerDiceStats, setPlayerDiceStats] = useState({});

      const generateRoomCode = () => Math.random().toString(36).substring(2, 8).toUpperCase();
      const generatePlayerId = () => Date.now().toString(36) + Math.random().toString(36).substring(2);

      const createRoom = () => {
        if (!username.trim()) return;
        const code = generateRoomCode();
        const playerId = generatePlayerId();
        
        database.ref(`rooms/${code}`).set({
          hostId: playerId,
          currentPlayerIndex: 0,
          dice: [1, 1, 1, 1, 1],
          locked: [false, false, false, false, false],
          rollsLeft: 3,
          isRolling: false,
          gameStarted: false,
          players: {
            [playerId]: { name: username, order: 0, scores: {}, diceStats: {} }
          }
        });
        
        setRoomCode(code);
        setMyPlayerId(playerId);
        setGameMode('lobby');
      };

      const joinRoom = async () => {
        if (!username.trim() || !roomCodeInput.trim()) return;
        const code = roomCodeInput.toUpperCase();
        const snapshot = await database.ref(`rooms/${code}`).once('value');
        
        if (!snapshot.exists()) {
          alert('Room not found!');
          return;
        }
        
        const roomData = snapshot.val();
        if (roomData.gameStarted) {
          alert('Game already in progress!');
          return;
        }
        
        const playerId = generatePlayerId();
        const playerCount = Object.keys(roomData.players || {}).length;
        
        database.ref(`rooms/${code}/players/${playerId}`).set({
          name: username,
          order: playerCount,
          scores: {},
          diceStats: {}
        });
        
        setRoomCode(code);
        setMyPlayerId(playerId);
        setGameMode('lobby');
      };

      useEffect(() => {
        if (!roomCode) return;
        const roomRef = database.ref(`rooms/${roomCode}`);
        const listener = roomRef.on('value', (snapshot) => {
          const data = snapshot.val();
          if (data) {
            setRoomData(data);
            if (data.gameStarted && gameMode !== 'playing') {
              setGameMode('playing');
            }
            
            // Update local dice stats
            if (data.players) {
              const allStats = {};
              Object.entries(data.players).forEach(([id, player]) => {
                if (player.diceStats) {
                  allStats[id] = player.diceStats;
                }
              });
              setPlayerDiceStats(allStats);
            }
          }
        });
        return () => roomRef.off('value', listener);
      }, [roomCode]);

      useEffect(() => {
        if (roomData && roomData.rollsLeft < 3 && !roomData.isRolling && roomData.dice.every(d => d === roomData.dice[0])) {
          setShowYahtzeeCelebration(true);
          playSound('yahtzee');
          setTimeout(() => setShowYahtzeeCelebration(false), 2000);
        }
      }, [roomData?.dice, roomData?.rollsLeft, roomData?.isRolling]);

      const startGame = () => {
        if (!roomData || Object.keys(roomData.players).length < 2) {
          alert('Need at least 2 players!');
          return;
        }
        database.ref(`rooms/${roomCode}`).update({ gameStarted: true });
      };

      const playSound = (type) => {
        if (!soundEnabled) return;
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        
        switch(type) {
          case 'roll':
            osc.frequency.value = 200;
            gain.gain.setValueAtTime(0.3, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.3);
            break;
          case 'lock':
            osc.frequency.value = 600;
            gain.gain.setValueAtTime(0.2, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + 0.1);
            break;
          case 'yahtzee':
            [400, 500, 600, 800].forEach((freq, i) => {
              const o = ctx.createOscillator();
              const g = ctx.createGain();
              o.connect(g);
              g.connect(ctx.destination);
              o.frequency.value = freq;
              g.gain.setValueAtTime(0.2, ctx.currentTime + i * 0.1);
              g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + i * 0.1 + 0.2);
              o.start(ctx.currentTime + i * 0.1);
              o.stop(ctx.currentTime + i * 0.1 + 0.2);
            });
            break;
        }
      };

      const isMyTurn = () => {
        if (!roomData?.players) return false;
        const playerIds = Object.keys(roomData.players).sort((a, b) => 
          roomData.players[a].order - roomData.players[b].order
        );
        return playerIds[roomData.currentPlayerIndex] === myPlayerId;
      };

      const rollDice = () => {
        if (!isMyTurn() || roomData.rollsLeft === 0 || roomData.isRolling) return;
        playSound('roll');
        
        const newDice = roomData.dice.map((die, i) => {
          if (roomData.locked[i]) return die;
          const rolled = Math.floor(Math.random() * 6) + 1;
          
          // Track dice stats
          const currentStats = roomData.players[myPlayerId].diceStats || {};
          const updates = {};
          updates[`players/${myPlayerId}/diceStats/${rolled}`] = (currentStats[rolled] || 0) + 1;
          updates[`players/${myPlayerId}/diceStats/total`] = (currentStats.total || 0) + 1;
          database.ref(`rooms/${roomCode}`).update(updates);
          
          return rolled;
        });
        
        database.ref(`rooms/${roomCode}`).update({
          dice: newDice,
          rollsLeft: roomData.rollsLeft - 1,
          isRolling: true
        });
        
        setTimeout(() => {
          database.ref(`rooms/${roomCode}`).update({ isRolling: false });
        }, 650);
      };

      const toggleLock = (index) => {
        if (!isMyTurn() || roomData.rollsLeft === 3 || roomData.isRolling) return;
        playSound('lock');
        const newLocked = [...roomData.locked];
        newLocked[index] = !newLocked[index];
        database.ref(`rooms/${roomCode}`).update({ locked: newLocked });
      };

      const calculateScore = (category, diceVals) => {
        const counts = diceVals.reduce((acc, val) => {
          acc[val] = (acc[val] || 0) + 1;
          return acc;
        }, {});
        const values = Object.values(counts);
        const sum = diceVals.reduce((a, b) => a + b, 0);

        switch (category) {
          case 'ones': return diceVals.filter(d => d === 1).length;
          case 'twos': return diceVals.filter(d => d === 2).length * 2;
          case 'threes': return diceVals.filter(d => d === 3).length * 3;
          case 'fours': return diceVals.filter(d => d === 4).length * 4;
          case 'fives': return diceVals.filter(d => d === 5).length * 5;
          case 'sixes': return diceVals.filter(d => d === 6).length * 6;
          case 'threeOfKind': return values.some(c => c >= 3) ? sum : 0;
          case 'fourOfKind': return values.some(c => c >= 4) ? sum : 0;
          case 'fullHouse': return values.includes(3) && values.includes(2) ? 25 : 0;
          case 'smallStraight': {
            const sorted = [...new Set(diceVals)].sort();
            return ['1234', '2345', '3456'].some(s => sorted.join('').includes(s)) ? 30 : 0;
          }
          case 'largeStraight': {
            const sorted = [...diceVals].sort().join('');
            return ['12345', '23456'].includes(sorted) ? 40 : 0;
          }
          case 'yahtzee': return values.includes(5) ? 50 : 0;
          case 'chance': return sum;
          default: return 0;
        }
      };

      const scoreCategory = (category) => {
        if (!isMyTurn() || roomData.rollsLeft === 3 || roomData.isRolling) return;
        
        const playerIds = Object.keys(roomData.players).sort((a, b) => 
          roomData.players[a].order - roomData.players[b].order
        );
        const currentPlayerId = playerIds[roomData.currentPlayerIndex];
        const currentPlayer = roomData.players[currentPlayerId];
        
        if (currentPlayer.scores?.[category] !== undefined) return;
        
        const score = calculateScore(category, roomData.dice);
        const isYahtzee = roomData.dice.every(d => d === roomData.dice[0]);
        const hasYahtzeeScore = currentPlayer.scores?.yahtzee !== undefined;
        const yahtzeeBoxHas50 = currentPlayer.scores?.yahtzee === 50;
        
        let bonusCount = currentPlayer.scores?.yahtzeeBonusCount || 0;
        if (isYahtzee && hasYahtzeeScore && yahtzeeBoxHas50 && category !== 'yahtzee') {
          bonusCount += 1;
        }
        
        const nextIndex = (roomData.currentPlayerIndex + 1) % playerIds.length;
        
        database.ref(`rooms/${roomCode}`).update({
          [`players/${currentPlayerId}/scores/${category}`]: score,
          [`players/${currentPlayerId}/scores/yahtzeeBonusCount`]: bonusCount,
          currentPlayerIndex: nextIndex,
          dice: [1, 1, 1, 1, 1],
          locked: [false, false, false, false, false],
          rollsLeft: 3
        });
      };

      const getPlayerTotal = (playerId) => {
        if (!roomData?.players[playerId]) return 0;
        const playerScores = roomData.players[playerId].scores || {};
        const upperScore = CATEGORIES.filter(c => c.upper).reduce((sum, c) => 
          sum + (playerScores[c.id] || 0), 0
        );
        const bonus = upperScore >= 63 ? 35 : 0;
        const lowerScore = CATEGORIES.filter(c => !c.upper).reduce((sum, c) => 
          sum + (playerScores[c.id] || 0), 0
        );
        const yahtzeeBonuses = (playerScores.yahtzeeBonusCount || 0) * 100;
        return upperScore + bonus + lowerScore + yahtzeeBonuses;
      };

      const getDieEmoji = (value) => ({ 1: '‚öÄ', 2: '‚öÅ', 3: '‚öÇ', 4: '‚öÉ', 5: '‚öÑ', 6: '‚öÖ' }[value] || 'üé≤');

      const copyRoomCode = () => {
        navigator.clipboard.writeText(roomCode);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      if (gameMode === 'menu') {
        return (
          <div className={`min-h-screen bg-gradient-to-br ${THEMES[currentTheme]} flex items-center justify-center p-4`}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-3xl shadow-2xl p-12 max-w-md w-full`}>
              <div className="text-center mb-8">
                <div className="text-6xl mb-4">üé≤</div>
                <h1 className={`text-4xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-2`}>Yahtzee!</h1>
                <p className={darkMode ? 'text-gray-300' : 'text-gray-600'}>Multiplayer Online</p>
              </div>
              <div className="space-y-4">
                <button
                  onClick={() => setGameMode('create')}
                  className="w-full bg-gradient-to-br from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white py-6 px-4 rounded-2xl font-bold text-2xl transition-all transform hover:scale-105 shadow-lg"
                >
                  üéÆ Create Room
                </button>
                <button
                  onClick={() => setGameMode('join')}
                  className="w-full bg-gradient-to-br from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 text-white py-6 px-4 rounded-2xl font-bold text-2xl transition-all transform hover:scale-105 shadow-lg"
                >
                  üö™ Join Room
                </button>
              </div>
            </div>
          </div>
        );
      }

      if (gameMode === 'create') {
        return (
          <div className={`min-h-screen bg-gradient-to-br ${THEMES[currentTheme]} flex items-center justify-center p-4`}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-3xl shadow-2xl p-12 max-w-md w-full`}>
              <h2 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-6 text-center`}>Create Room</h2>
              <input
                type="text"
                placeholder="Enter your name"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none text-lg mb-4 ${
                  darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300'
                }`}
              />
              <button
                onClick={createRoom}
                disabled={!username.trim()}
                className="w-full bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 disabled:from-gray-400 disabled:to-gray-500 text-white py-4 rounded-2xl font-bold text-xl mb-4"
              >
                Create Room
              </button>
              <button
                onClick={() => setGameMode('menu')}
                className={`w-full ${darkMode ? 'bg-gray-700' : 'bg-gray-200'} py-3 rounded-xl font-semibold`}
              >
                Back
              </button>
            </div>
          </div>
        );
      }

      if (gameMode === 'join') {
        return (
          <div className={`min-h-screen bg-gradient-to-br ${THEMES[currentTheme]} flex items-center justify-center p-4`}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-3xl shadow-2xl p-12 max-w-md w-full`}>
              <h2 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-6 text-center`}>Join Room</h2>
              <input
                type="text"
                placeholder="Enter your name"
                value={username}
                onChange={(e) => setUsername(e.target.value)}
                className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none text-lg mb-4 ${
                  darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300'
                }`}
              />
              <input
                type="text"
                placeholder="Enter room code"
                value={roomCodeInput}
                onChange={(e) => setRoomCodeInput(e.target.value.toUpperCase())}
                className={`w-full px-4 py-3 border-2 rounded-xl focus:outline-none text-lg mb-4 ${
                  darkMode ? 'bg-gray-700 border-gray-600 text-white placeholder-gray-400' : 'bg-white border-gray-300'
                }`}
              />
              <button
                onClick={joinRoom}
                disabled={!username.trim() || !roomCodeInput.trim()}
                className="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 disabled:from-gray-400 disabled:to-gray-500 text-white py-4 rounded-2xl font-bold text-xl mb-4"
              >
                Join Room
              </button>
              <button
                onClick={() => setGameMode('menu')}
                className={`w-full ${darkMode ? 'bg-gray-700' : 'bg-gray-200'} py-3 rounded-xl font-semibold`}
              >
                Back
              </button>
            </div>
          </div>
        );
      }

      if (gameMode === 'lobby') {
        const players = roomData ? Object.entries(roomData.players).sort(([, a], [, b]) => a.order - b.order) : [];
        const isHost = roomData?.hostId === myPlayerId;

        return (
          <div className={`min-h-screen bg-gradient-to-br ${THEMES[currentTheme]} flex items-center justify-center p-4`}>
            <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-3xl shadow-2xl p-12 max-w-2xl w-full`}>
              <h2 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-6 text-center`}>Game Lobby</h2>
              
              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-xl p-6 mb-6`}>
                <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'} mb-2 text-center`}>Room Code</p>
                <div className="flex items-center justify-center gap-3">
                  <p className={`text-4xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} tracking-wider`}>{roomCode}</p>
                  <button
                    onClick={copyRoomCode}
                    className={`${darkMode ? 'bg-gray-600' : 'bg-gray-200'} p-3 rounded-lg`}
                  >
                    {copied ? '‚úì' : 'üìã'}
                  </button>
                </div>
              </div>

              <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-xl p-6 mb-6`}>
                <h3 className={`text-xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'} mb-4`}>Players ({players.length})</h3>
                <div className="space-y-2">
                  {players.map(([id, player]) => (
                    <div key={id} className={`${darkMode ? 'bg-gray-600' : 'bg-white'} rounded-lg p-3 flex items-center justify-between`}>
                      <span className={`font-semibold ${darkMode ? 'text-white' : 'text-gray-800'}`}>{player.name}</span>
                      {id === roomData?.hostId && (
                        <span className="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-xs font-bold">HOST</span>
                      )}
                    </div>
                  ))}
                </div>
              </div>

              {isHost ? (
                <button
                  onClick={startGame}
                  disabled={players.length < 2}
                  className="w-full bg-gradient-to-r from-green-500 to-teal-600 hover:from-green-600 hover:to-teal-700 disabled:from-gray-400 disabled:to-gray-500 text-white py-4 rounded-2xl font-bold text-xl"
                >
                  {players.length < 2 ? 'Waiting for players...' : 'Start Game'}
                </button>
              ) : (
                <div className={`text-center ${darkMode ? 'text-gray-300' : 'text-gray-600'} py-4`}>
                  Waiting for host to start the game...
                </div>
              )}
            </div>
          </div>
        );
      }

      if (gameMode === 'playing' && roomData) {
        const players = Object.entries(roomData.players).sort(([, a], [, b]) => a.order - b.order);
        const playerIds = players.map(([id]) => id);
        const currentPlayerId = playerIds[roomData.currentPlayerIndex];
        const currentPlayer = roomData.players[currentPlayerId];

        return (
          <div className={`min-h-screen bg-gradient-to-br ${THEMES[currentTheme]} p-4`}>
            <div className="max-w-7xl mx-auto">
              <div className="text-center mb-6">
                <div className="flex justify-between items-center mb-4">
                  <div className={`${darkMode ? 'bg-gray-800/90' : 'bg-white/90'} backdrop-blur rounded-xl px-4 py-2`}>
                    <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>Room: {roomCode}</p>
                  </div>
                  <div className="flex gap-2">
                    <button onClick={() => setSoundEnabled(!soundEnabled)} className={`${soundEnabled ? 'bg-green-600' : 'bg-gray-600'} text-white px-4 py-2 rounded-lg font-semibold hover:scale-105 transition-all shadow-lg`}>
                      {soundEnabled ? 'üîä' : 'üîá'}
                    </button>
                    <button onClick={() => setShowDebug(!showDebug)} className="bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold hover:scale-105 transition-all shadow-lg">
                      üêõ
                    </button>
                    <button onClick={() => setDarkMode(!darkMode)} className={`${darkMode ? 'bg-yellow-400 text-gray-900' : 'bg-gray-800 text-white'} px-4 py-2 rounded-lg font-semibold hover:scale-105 transition-all shadow-lg`}>
                      {darkMode ? '‚òÄÔ∏è' : 'üåô'}
                    </button>
                  </div>
                </div>
                <h1 className="text-5xl font-bold text-white mb-4 drop-shadow-lg">üé≤ Yahtzee üé≤</h1>
                <div className={`${darkMode ? 'bg-gray-800/90' : 'bg-white/90'} backdrop-blur rounded-2xl px-6 py-3 inline-block shadow-xl`}>
                  <p className="text-2xl font-bold text-indigo-400">
                    {currentPlayer?.name}'s Turn {isMyTurn() && '(You!)'}
                  </p>
                  <p className={`${darkMode ? 'text-gray-300' : 'text-gray-600'} font-semibold`}>Rolls Left: {roomData.rollsLeft}</p>
                </div>
              </div>

              <div className={`${darkMode ? 'bg-gray-800/95' : 'bg-white/95'} backdrop-blur rounded-3xl shadow-2xl p-8 mb-6`}>
                <div className="flex justify-center flex-wrap gap-2 mb-6 relative">
                  {showYahtzeeCelebration && (
                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none z-10">
                      <div className="bg-gradient-to-r from-yellow-300 via-yellow-400 to-yellow-300 px-8 py-4 rounded-2xl shadow-2xl border-4 border-yellow-500" style={{ animation: 'celebrateBounce 0.5s ease-in-out infinite' }}>
                        <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-600 via-purple-600 to-blue-600">YAHTZEE!</div>
                        <div className="flex justify-center gap-2 text-4xl mt-2">
                          {[...Array(5)].map((_, i) => (
                            <span key={i} style={{ animation: `bounce 0.4s ease-in-out infinite`, animationDelay: `${i * 0.1}s` }}>{getDieEmoji(roomData.dice[0])}</span>
                          ))}
                        </div>
                      </div>
                    </div>
                  )}
                  {roomData.dice.map((die, i) => (
                    <Die3D key={i} value={die} locked={roomData.locked[i]} onClick={() => toggleLock(i)} isRolling={roomData.isRolling} />
                  ))}
                </div>
                <div className="text-center">
                  <button
                    onClick={rollDice}
                    disabled={roomData.rollsLeft === 0 || roomData.isRolling || !isMyTurn()}
                    className="bg-gradient-to-r from-emerald-500 to-teal-600 hover:from-emerald-600 hover:to-teal-700 disabled:from-gray-400 disabled:to-gray-500 text-white px-12 py-4 rounded-2xl font-bold text-xl transition-all transform hover:scale-105 shadow-lg disabled:cursor-not-allowed"
                  >
                    {roomData.isRolling ? 'üé≤ Rolling...' : !isMyTurn() ? '‚è≥ Wait Your Turn' : 'üé≤ Roll Dice'}
                  </button>
                  <p className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'} mt-2 h-5`}>
                    {roomData.rollsLeft < 3 && !roomData.isRolling && isMyTurn() ? 'Click dice to lock/unlock them' : '\u00A0'}
                  </p>
                </div>
              </div>

              {showDebug && (
                <div className={`${darkMode ? 'bg-gray-800/95' : 'bg-white/95'} backdrop-blur rounded-3xl shadow-2xl p-6 mb-6`}>
                  <div className="bg-blue-900/50 border-2 border-blue-400 rounded-lg p-3">
                    <p className="font-bold text-blue-300 mb-2">DEBUG - Dice Values:</p>
                    <p className="text-2xl font-mono text-blue-200">[{roomData.dice.join(', ')}]</p>
                  </div>
                </div>
              )}

              <div className="grid gap-6" style={{ gridTemplateColumns: `repeat(${players.length}, 1fr)` }}>
                {players.map(([playerId, player]) => (
                  <div key={playerId} className={`${darkMode ? 'bg-gray-800/95' : 'bg-white/95'} backdrop-blur rounded-2xl shadow-xl overflow-hidden ${isMyTurn() && playerId === myPlayerId ? 'ring-4 ring-yellow-400' : ''}`}>
                    <div className="bg-gradient-to-r from-gray-700 to-gray-800 text-white p-4 text-center">
                      <h3 className="font-bold text-2xl mb-1">{player.name} {playerId === myPlayerId && '(You)'}</h3>
                      <p className="text-lg font-semibold">Total: {getPlayerTotal(playerId)}</p>
                      <button
                        onClick={() => setSelectedPlayerStats(playerId)}
                        className="mt-2 bg-white/20 hover:bg-white/30 px-4 py-1 rounded-lg text-sm font-semibold transition-all"
                      >
                        üìä View Stats
                      </button>
                    </div>
                    <div className="p-4">
                      {CATEGORIES.map(category => {
                        const scored = player.scores?.[category.id] !== undefined;
                        const bonusCount = player.scores?.yahtzeeBonusCount || 0;
                        const canScore = !scored && playerId === myPlayerId && isMyTurn() && roomData.rollsLeft < 3 && !roomData.isRolling;
                        const potentialScore = canScore ? calculateScore(category.id, roomData.dice) : 0;

                        return (
                          <div
                            key={category.id}
                            onClick={() => canScore && scoreCategory(category.id)}
                            className={`flex justify-between items-center py-3 px-4 mb-1 rounded-lg border-b ${darkMode ? 'border-gray-700' : 'border-gray-200'} ${
                              scored ? (darkMode ? 'bg-gray-700' : 'bg-gray-100') : (darkMode ? 'bg-gray-800' : 'bg-white')
                            } ${canScore ? 'cursor-pointer hover:ring-2 hover:ring-inset hover:ring-gray-400 transition-all' : ''} ${
                              category.upper && category.id === 'sixes' ? (darkMode ? 'border-b-2 border-gray-600 mb-2' : 'border-b-2 border-gray-300 mb-2') : ''
                            }`}
                          >
                            <span className={`font-semibold text-base ${darkMode ? 'text-gray-200' : 'text-gray-800'}`}>{category.name}</span>
                            <span className={`font-bold text-xl ${darkMode ? 'text-indigo-400' : 'text-indigo-600'}`}>
                              {scored
                                ? category.id === 'yahtzee' && bonusCount > 0
                                  ? `${player.scores[category.id]} (+${bonusCount * 100})`
                                  : player.scores[category.id]
                                : canScore
                                ? `(${potentialScore})`
                                : '-'}
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {selectedPlayerStats !== null && (
              <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setSelectedPlayerStats(null)}>
                <div className={`${darkMode ? 'bg-gray-800' : 'bg-white'} rounded-3xl shadow-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto`} onClick={(e) => e.stopPropagation()}>
                  <div className="flex justify-between items-center mb-6">
                    <h2 className={`text-3xl font-bold ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                      {roomData.players[selectedPlayerStats]?.name}'s Stats
                    </h2>
                    <button
                      onClick={() => setSelectedPlayerStats(null)}
                      className={`${darkMode ? 'bg-gray-700 hover:bg-gray-600' : 'bg-gray-200 hover:bg-gray-300'} rounded-full w-10 h-10 flex items-center justify-center font-bold text-xl transition-all`}
                    >
                      √ó
                    </button>
                  </div>
                  
                  <div className="space-y-4">
                    <div className="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-xl p-4 text-white text-center">
                      <p className="text-sm opacity-90">Total Score</p>
                      <p className="text-5xl font-bold">{getPlayerTotal(selectedPlayerStats)}</p>
                    </div>

                    {playerDiceStats[selectedPlayerStats]?.total > 0 && (
                      <div className={`${darkMode ? 'bg-gray-700' : 'bg-gray-100'} rounded-lg p-4`}>
                        <h3 className={`text-lg font-bold mb-3 ${darkMode ? 'text-white' : 'text-gray-800'}`}>
                          Dice Roll Distribution
                        </h3>
                        <p className={`text-sm mb-4 ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                          Total dice rolled: {playerDiceStats[selectedPlayerStats].total}
                        </p>
                        <div className="space-y-3">
                          {[1, 2, 3, 4, 5, 6].map(num => {
                            const count = playerDiceStats[selectedPlayerStats][num] || 0;
                            const total = playerDiceStats[selectedPlayerStats].total || 1;
                            const percentage = ((count / total) * 100).toFixed(1);
                            return (
                              <div key={num}>
                                <div className="flex justify-between items-center mb-1">
                                  <span className={`font-semibold ${darkMode ? 'text-gray-200' : 'text-gray-700'}`}>
                                    {getDieEmoji(num)} {num}
                                  </span>
                                  <span className={`text-sm ${darkMode ? 'text-gray-300' : 'text-gray-600'}`}>
                                    {count} ({percentage}%)
                                  </span>
                                </div>
                                <div className={`w-full ${darkMode ? 'bg-gray-600' : 'bg-gray-300'} rounded-full h-2`}>
                                  <div
                                    className="bg-gradient-to-r from-indigo-500 to-purple-500 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${percentage}%` }}
                                  />
                                </div>
                              </div>
                            );
                          })}
                        </div>
                        <div className={`mt-4 pt-4 border-t ${darkMode ? 'border-gray-600' : 'border-gray-300'}`}>
                          <p className={`text-xs ${darkMode ? 'text-gray-400' : 'text-gray-500'} text-center`}>
                            Expected average: 16.7% per number
                          </p>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      return null;
    }

    ReactDOM.render(<YahtzeeGame />, document.getElementById('root'));
  </script>
</body>
</html>
